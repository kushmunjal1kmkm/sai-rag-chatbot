name: Deploy SAI RAG Chatbot

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      run_duration:
        description: 'How long to run the server (in minutes, max 360)'
        required: false
        default: '60'

jobs:
  deploy-chatbot:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours maximum
    
    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flask-cors  # Add CORS support
        
    - name: ğŸ”§ Create Environment File
      run: |
        mkdir -p config
        cat > config/.env << EOF
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        DEBUG=False
        FLASK_PORT=5000
        HOST=0.0.0.0
        EOF
        
    - name: ğŸ“ Verify Project Structure
      run: |
        echo "ğŸ“‚ Project Structure:"
        find . -type f -name "*.py" | head -10
        echo "ğŸ“„ Config files:"
        ls -la config/
        echo "ğŸ“Š Source files:"
        ls -la src/
        
    - name: ğŸ” Test Application Startup
      run: |
        echo "ğŸ§ª Testing application startup..."
        timeout 30s python main_app.py &
        sleep 5
        if curl -f http://localhost:5000/health; then
          echo "âœ… Application started successfully"
        else
          echo "âŒ Application failed to start"
          exit 1
        fi
        pkill -f python || true
        
    - name: ğŸŒ Start SAI RAG Chatbot Server
      run: |
        echo "ğŸš€ Starting SAI RAG Chatbot Server..."
        echo "â° Server will run for ${{ github.event.inputs.run_duration || '60' }} minutes"
        echo "ğŸ”— Access URLs will be available in ngrok step"
        
        # Install ngrok for public URL
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok
        
        # Start ngrok in background
        ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ngrok http 5000 --log=stdout > ngrok.log &
        sleep 5
        
        # Get public URL
        PUBLIC_URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "ğŸŒ Public URL: $PUBLIC_URL"
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV
        
        # Start Flask app
        python main_app.py &
        FLASK_PID=$!
        
        echo "âœ… Server started with PID: $FLASK_PID"
        echo "â° Running for ${{ github.event.inputs.run_duration || '60' }} minutes..."
        
        # Keep server running
        sleep $(( ${{ github.event.inputs.run_duration || '60' }} * 60 ))
        
        echo "â° Time limit reached. Stopping server..."
        kill $FLASK_PID || true
        
    - name: ğŸ“Š Display Server Information
      if: always()
      run: |
        echo "ğŸ”— SAI RAG Chatbot was accessible at: $PUBLIC_URL"
        echo "ğŸ“Š Server ran for: ${{ github.event.inputs.run_duration || '60' }} minutes"
        echo "ğŸ“ˆ Check logs above for any errors or usage statistics"
        
        # Display ngrok logs
        echo "ğŸ“‹ Ngrok access logs:"
        if [ -f ngrok.log ]; then
          tail -20 ngrok.log
        fi

  # Optional: Send notification when server starts
  notify:
    needs: deploy-chatbot
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: ğŸ“§ Send Notification
      run: |
        echo "ğŸ”” SAI RAG Chatbot deployment completed"
        echo "âœ… Status: ${{ needs.deploy-chatbot.result }}"
        # Add webhook notification here if needed